```{r Global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=10, fig.height=6, echo=FALSE, warning=FALSE, message=FALSE)
```
  
## Methods
With funding from the Stop TB Partnershipâ€™s TB REACH initiative, three TB Screening Centres (SCs) were established across Dhaka. A Delft EZ DR X-ray system was installed in each TB SC along with multiple 4-module GeneXpert systems. A custom-built mHealth application connected to a medical record system (OpenMRS) was deployed to systematically capture demographics and symptom data from all individuals visiting the TB SCs. A referral network of more than 2,000 private providers was established, to refer clients for testing services at one of the three SCs. In addition, 133 NTP facilities were engaged to encourage referral of smear-negative individuals for Xpert testing. The TB SCs were also open to walk-in clients with no referral history.  
  
Adults (> 15 years) presenting at any of the TB SCs were verbally screened for the presence of TB symptoms. Regardless of the CAD4TB abnormality score, symptomatic individuals were asked to submit a sputum sample for a free Xpert test. If the Xpert test failed (invalid, error, or no result), it was performed again to obtain a valid outcome if enough sample remained. A Bangladeshi, board-certified radiologist with 10 years of experience read all of the CXR images offsite. The radiologist was blinded to both the CAD4TB score and the Xpert result. CXRs were graded as normal or abnormal. The radiologist provided a standard radiology report to guide clinical care. Anyone who was unable or unwilling to pay for the CXR was referred to a nearby public-sector health facility.
  

```{r Load, results='hide'}
source("DataWrangling/GlobalOption.R")

# MDF <- subset(MDF, MDF$Age > 15)
library(tableone)

# Define numeric variables
listVar <- c("Age", "Gender", "Cough", "Fever", "Active.Breathing.Shortness", "Weight.Loss","Haemoptysis", "Symptoms", "TB.Medication.History", "Xpert2Outcome_num", "MTB.Burden", "RIF.Result", "Referral", "rad.highly.TB", "rad.TB", "rad.abn", "CAD4TB6", "qXRv2", "LunitScore", "JF1", "IF1", "IF2")

#Define categorical variables
catVars <- c( "Gender", "Cough", "Fever", "Active.Breathing.Shortness", "Weight.Loss","Haemoptysis", "Symptoms", "TB.Medication.History", "Xpert2Outcome_num", "MTB.Burden", "RIF.Result", "Referral", "rad.highly.TB", "rad.TB", "rad.abn")


table1 <- CreateTableOne(vars = listVar, strata=c("Xpert2Outcome_num"), data = MDF, factorVars = catVars)
table1.all <- CreateTableOne(vars = listVar, data = MDF, factorVars = catVars)


table1 <- print(table1, nonnormal = c("Age", "CAD4TB6", "qXRv2", "LunitScore", "JF1", "IF1", "IF2"), cramVars = "Gender", catDigits = 1, contDigits = 1, noSpaces = TRUE)
table1all <- print(table1.all, nonnormal = c("Age","CAD4TB6", "qXRv2", "LunitScore", "JF1", "IF1", "IF2"), cramVars = "Gender", catDigits = 1, contDigits = 1, noSpaces = TRUE)

```


```{r Table 1}
table1DF <- data.frame(columnNameILike = row.names(table1), table1)
table1allDF <- data.frame(columnNameILike = row.names(table1all), table1all)
T1 <- cbind(table1DF, table1allDF)
T1 <- T1[, c(1, 3, 2, 4, 7)]
colnames(T1) <- c("", "Xpert Positive", "Xpert Negative", "p test", "Overall")

TEMP <- scan(text = "n,Age (median [IQR]),Gender = F/M (%),Cough = Yes (%),Fever = Yes (%),Short of breath = Yes (%),Weight Loss = Yes (%),Haemoptysis = Yes (%),Any symptom(s) = Yes (%),TB History = Yes (%),Xpert positive (%),MTB Burden (%),   ,   High,   Low,   Medium,   Very Low,RIF Result (%),   ,   Detected,   Indeterminate,   Not Detected,Referral Type(%),   Private Provider,   Public DOTS Facilities,   Walk-in,Radiologist = Highly suggestive of TB (%),Radiologist = Possibly TB (%),Radiologist = Any abnormality (%),CAD4TB (median [IQR]),qXR (median [IQR]),Lunit (median [IQR]),JF1 (median [IQR]), IF1, IF2", sep = ",", what = "")

# TEMP <- scan(text = "n,Age (median [IQR]),Gender = F/M (%),Cough = Yes (%),Fever = Yes (%),Short of breath = Yes (%),Weight Loss = Yes (%),Haemoptysis = Yes (%),TB History = Yes (%),Xpert positive (%),MTB Burden (%),   ,   High,   Low,   Medium,   Very Low,RIF Result (%),   ,   Detected,   Indeterminate,   Not Detected,Referral Type(%),   Private Provider,   Public DOTS Facilities,   Walk-in,Radiologist = Highly suggestive of TB (%),Radiologist = Possibly TB (%),Radiologist = Any abnormality (%),CAD4TB (median [IQR]),qXR (median [IQR]),Lunit (median [IQR]),JF1 (median [IQR]), IF1, IF2", sep = ",", what = "")

T1$N <- TEMP
T1 <- T1[, c(6, 2:5)]
rm(TEMP)
write.csv(T1, "Results/Table 1.csv", row.names = FALSE)


knitr::kable(T1, row.names = FALSE, caption = "Table 1 Demographic and Clinical Characteristics of People Screened with Chest X-ray and Xpert MTB/RIF")


rm(table1.all, table1all, table1allDF, table1, table1DF, listVar, catVars)
```

### Results
Between March 2014 and December 2016, a total of `r  length(MDF$X)` people were consecutively recruited from the three TB SCs. There were `r sum(is.na(MDF$rad.abn)==T)` individuals not able to obtain a  CXR. Further excluding `r sum(MDF$Age<15)` individuals aged 15 or less from the analysis, a total of `r sum(MDF$Age>=15)`  individuals were enrolled in the study. 

The median age of the rest were `r T1$Overall[2]`, the ratio between female and male participants was `r T1$Overall[3]`. Most participants `r T1$Overall[4]`,  reported coughing more than 14 days (or any cough? icddr,b please check), `r T1$Overall[5]` reported fever, `r T1$Overall[7]` reported weight loss; about half reported short of breath `r T1$Overall[6]`; `r  T1$Overall[8]` reported hemoptysis. Almost all, `r T1$Overall[9]` had at least one TB-related symptom.	
  
There are three sources of patients: the greatest proportion of test results came from people who were referred by their private provider (n=`r T1$Overall[24]`);  `r T1$Overall[25]` were referred from NTP facilities after a negative smear; and `r T1$Overall[26]` individual were walked-in / self-present (Table 1).  
  

#### Histogram 
```{r Histogram, fig.width=8, fig.height=5,}
p <- ggplot(MDF_long,aes(x=AbnormalityScore, fill=Xpert2Outcome_num))+ geom_histogram(position = 'stack', alpha=0.5, breaks=seq(0,100, by=5), aes(y = ..density.., fill = Xpert2Outcome_num)) + xlab("Abnormality Scores of the Deep Learning Systems") + scale_fill_discrete(name ="", labels = c("Xpert Negative", "Xpert Positive"))
hist <- p + facet_wrap(~DeepLearningSystem) + theme_minimal() + theme(legend.position = "bottom")+ scale_color_brewer(palette="Accent")

tiff("Results/Histogram.tif", width = 14, height = 8, units = "in", res = 100)
hist
dev.off()

library(moments)
# skewness(MDF[MDF$Xpert2Outcome_num ==1, 28]) 
# skewness(MDF[MDF$Xpert2Outcome_num ==1, 29]) 
# skewness(MDF[MDF$Xpert2Outcome_num ==1, 30])
# 
# skewness(MDF[MDF$Xpert2Outcome_num ==0, 28]) 
# skewness(MDF[MDF$Xpert2Outcome_num ==0, 29]) 
# skewness(MDF[MDF$Xpert2Outcome_num ==0, 30])
hist
```

###  ROC (Xpert Reference) 
```{r ROC}
source("radiologist.R")

CAD_Xpert_plot <- read.csv("Results/CAD_Xpert Cutoffs TABLE.csv")
CAD_Xpert_plot <- CAD_Xpert_plot[, -1]
# CAD_Xpert_plot <- CAD_Xpert_plot[!CAD_Xpert_plot$DeepLearningSystem %in% "Lunit", ]

roc_CAD6 <- ci.auc(Xpert2Outcome_num ~ CAD4TB6, MDF)
roc_qure <- ci.auc(Xpert2Outcome_num ~ qXRv2_100, MDF)
roc_Lunit <- ci.auc(Xpert2Outcome_num ~ LunitScore_100, MDF)
roc_JF1 <- ci.auc(Xpert2Outcome_num ~ JF1_100, MDF)
roc_JF2 <- ci.auc(Xpert2Outcome_num ~ JF2_100, MDF)
roc_IF1 <- ci.auc(Xpert2Outcome_num ~ IF1_100, MDF)
roc_IF2 <- ci.auc(Xpert2Outcome_num ~ IF2_100, MDF)


# base <- ggplot(CAD_Xpert_plot, aes(X, Sens, color = DeepLearningSystem)) + geom_path()+ geom_ribbon(aes(x = X, ymin = Sens_L, ymax = Sens_H), fill = "red", alpha= 0.2)

base <- ggplot(CAD_Xpert_plot, aes(X, Sens)) + geom_path(aes(color = DeepLearningSystem)) + 
  geom_ribbon(aes(x = X, ymin = Sens_L, ymax = Sens_H, color = DeepLearningSystem), fill = "steelblue", alpha= 0.2) 


ggROC <- base + theme_minimal() + geom_abline(slope=1, intercept = 0, linetype = "dashed", alpha=0.7, color = "grey") + coord_equal()+ annotate("text", x = .75, y = .15, 
            label = paste(" CAD4TB: ", round(roc_CAD6[2],2), " (95% CI:", round(roc_CAD6[1],2), "-", round(roc_CAD6[3],2), ")", "\n",
      "Lunit: ", round(roc_Lunit[2],2), " (95% CI:", round(roc_Lunit[1],2), "-", round(roc_Lunit[3],2), ")", "\n",
      "JF1: ", round(roc_JF1[2],2), " (95% CI:", round(roc_JF1[1],2), "-", round(roc_JF1[3],2), ")", "\n",
       "JF2: ", round(roc_JF2[2],2), " (95% CI:", round(roc_JF2[1],2), "-", round(roc_JF2[3],2), ")", "\n",
       "IF1: ", round(roc_IF1[2],2), " (95% CI:", round(roc_IF1[1],2), "-", round(roc_IF1[3],2), ")", "\n",
       "IF2: ", round(roc_IF2[2],2), " (95% CI:", round(roc_IF2[1],2), "-", round(roc_IF2[3],2), ")", "\n",
      "qXR: ", round(roc_qure[2],2), " (95% CI:", round(roc_qure[1],2), "-", round(roc_qure[3],2), ")", "\n", sep = ""), size = 3) +
  labs(x = "1-Specificity", y= "Sensitivity", subtitle = paste0("Figure X: The ROC curves of CAD4TB (v6), JF (v1) and qXR (v2) using Xpert results as the reference (n=", length(MDF$PID_OMRS), ")")) 

ggROC <- ggROC + geom_point(data = Radiologist, mapping = aes(X, Sens, shape = RadiologistCategory)) 
# + geom_ribbon(Radiologist, aes(x=X, ymin = Sens_L, ymax = Sens_H), fill = "red", alpha = 0.2)
  
tiff("Results/Figure-2 ROCs.tif", width = 10, height = 7.9, units = "in", res = 100)
ggROC
dev.off()

ggROC1 <- ggROC + coord_cartesian(xlim = c(0.1, 0.5), ylim = c(0.90, 1) ) +
  ggtitle("Figure 2b: Zoomed-in view of the square marked part of Fig. 2a")+theme_light()

tiff("Results/Figure-2 Zoomed-in.tif", width = 12, height = 4, units = "in", res = 100)
ggROC1
dev.off()
ggROC
ggROC1


rm(ggROC, ggROC1, Highly, hist, accuracy, accuracy_both, Any, base, CAD_Xpert_select, CAD_Xpert, Probably, mylist, rval, table1, table1.all, roc_CAD6, roc_JF1, roc_JF2, roc_qure, roc_Lunit)
```
  

###  Precision Recall Curve (Xpert Reference) 
```{r PR Curve}
CAD_Xpert_plot <- CAD_Xpert_plot[!CAD_Xpert_plot$DeepLearningSystem %in% "JF2", ]

# roc_CAD6 <- ci.auc(Xpert2Outcome_num ~ CAD4TB6, MDF)
# roc_qure <- ci.auc(Xpert2Outcome_num ~ qXRv2_100, MDF)
# roc_Lunit <- ci.auc(Xpert2Outcome_num ~ LunitScore_100, MDF)
# roc_JF1 <- ci.auc(Xpert2Outcome_num ~ JF1_100, MDF)
# roc_JF2 <- ci.auc(Xpert2Outcome_num ~ JF2_100, MDF)
# 

# base <- ggplot(CAD_Xpert_plot, aes(X, Sens, color = DeepLearningSystem)) + geom_path()+ geom_ribbon(aes(x = X, ymin = Sens_L, ymax = Sens_H), fill = "red", alpha= 0.2)

base <- ggplot(CAD_Xpert_plot, aes(Sens, ppv)) + geom_path(aes(color = DeepLearningSystem)) + geom_ribbon(aes(x = Sens, ymin = PPV_L, ymax = PPV_H, color = DeepLearningSystem), fill = "steelblue", alpha= 0.2)


PRCurve <- base + theme_minimal() + geom_abline(slope=1, intercept = 0, linetype = "dashed", alpha=0.7, color = "grey") + coord_equal()
# + annotate("text", x = .75, y = .15, 
#             label = paste(" CAD4TB: ", round(roc_CAD6[2],2), " (95% CI:", round(roc_CAD6[1],2), "-", round(roc_CAD6[3],2), ")", "\n",
#       "Lunit: ", round(roc_Lunit[2],2), " (95% CI:", round(roc_Lunit[1],2), "-", round(roc_Lunit[3],2), ")", "\n",
#       "JF1: ", round(roc_JF1[2],2), " (95% CI:", round(roc_JF1[1],2), "-", round(roc_JF1[3],2), ")", "\n",
#        "JF2: ", round(roc_JF2[2],2), " (95% CI:", round(roc_JF2[1],2), "-", round(roc_JF2[3],2), ")", "\n",
#       "qXR: ", round(roc_qure[2],2), " (95% CI:", round(roc_qure[1],2), "-", round(roc_qure[3],2), ")", "\n", sep = ""), size = 3) +
#   labs(x = "1-Specificity", y= "Sensitivity", subtitle = "Figure X: The ROC curves of CAD4TB (v6), JF (v1) and qXR (v2) using Xpert results as the reference (n=23,618)") 

# ggROC <- ggROC + geom_point(data = Radiologist, mapping = aes(X, Sens, shape = RadiologistCategory)) 
# + geom_ribbon(Radiologist, aes(x=X, ymin = Sens_L, ymax = Sens_H), fill = "red", alpha = 0.2)
  
tiff("Results/Figure-3 PR Curves.tif", width = 10, height = 7.9, units = "in", res = 100)
PRCurve
dev.off()


```

  
