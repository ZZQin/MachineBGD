```{r Global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=15, fig.height=12, echo=FALSE, warning=FALSE, message=FALSE)
```


```{r eval=F}
source("DataWrangling/GlobalOption.R")
source("radiologist.R")
Radiologist <- Radiologist[Radiologist$Referral %in% "MDF", ]

New <- MDF[MDF$TB.Medication.History %in% "No",]
Old <- MDF[MDF$TB.Medication.History %in% "Yes",]

Young <- MDF[MDF$AgeGroup %in% "[15,25)",]
Middle <- MDF[MDF$AgeGroup %in% "[25,60)",]
Senior <- MDF[MDF$AgeGroup %in% "[60,108]",]

Referral <- subset(MDF, MDF$UseCase %in% "PrivatePublicReferral")
DOTS <- subset(MDF, MDF$UseCase %in% "PublicDOTSRetesting")
WalkIn <- subset(MDF, MDF$UseCase %in% "WalkIn")
# Missing <- subset(MDF, is.na(MDF$UseCase)==T)

New_long <- MDF_long[MDF_long$TB.Medication.History %in% "No",]
Old_long <- MDF_long[MDF_long$TB.Medication.History %in% "Yes",]
Young_long <- MDF_long[MDF_long$AgeGroup %in% "[15,25)",]
Middle_long <- MDF_long[MDF_long$AgeGroup %in% "[25,60)",]
Senior_long <- MDF_long[MDF_long$AgeGroup %in% "[60,108]",]

Referral_long  <- subset(MDF_long, MDF_long$UseCase %in% "PrivatePublicReferral")
DOTS_long  <- subset(MDF_long, MDF_long$UseCase %in% "PublicDOTSRetesting")
WalkIn_long  <- subset(MDF_long, MDF_long$UseCase %in% "WalkIn")
# Missing_long  <- subset(MDF, is.na(MDF$UseCase)==T)

# source("Chapter/Subgroup Table/Young.R")
# source("Chapter/Subgroup Table/Middle.R")
# source("Chapter/Subgroup Table/Senior.R")
# source("Chapter/Subgroup Table/Referral.R")
# source("Chapter/Subgroup Table/DOTS.R")
# write.csv(CAD_Xpert_plot_Middle, "Chapter/Subgroup Table/CAD_Xpert_plot_Middle.csv")
# write.csv(CAD_Xpert_plot_Young, "Chapter/Subgroup Table/CAD_Xpert_plot_Young.csv")
# write.csv(CAD_Xpert_plot_Senior, "Chapter/Subgroup Table/CAD_Xpert_plot_Senior.csv")
# write.csv(CAD_Xpert_plot_Referral, "Chapter/Subgroup Table/CAD_Xpert_plot_Referral.csv")
# write.csv(CAD_Xpert_plot_DOTS, "Chapter/Subgroup Table/CAD_Xpert_plot_DOTS.csv")
# write.csv(CAD_Xpert_plot_WalkIn, "Chapter/Subgroup Table/CAD_Xpert_plot_WalkIn.csv")
# write.csv(CAD_Xpert_plot_New, "Chapter/Subgroup Table/CAD_Xpert_plot_New.csv")
# write.csv(CAD_Xpert_plot_Old, "Chapter/Subgroup Table/CAD_Xpert_plot_Old.csv")


CAD_Xpert_plot_Middle <- read.csv("Chapter/Subgroup Table/CAD_Xpert_plot_Middle.csv")
CAD_Xpert_plot_Young <- read.csv("Chapter/Subgroup Table/CAD_Xpert_plot_Young.csv")
CAD_Xpert_plot_Senior <- read.csv("Chapter/Subgroup Table/CAD_Xpert_plot_Senior.csv")
CAD_Xpert_plot_DOTS <- read.csv("Chapter/Subgroup Table/CAD_Xpert_plot_DOTS.csv")
CAD_Xpert_plot_WalkIn <- read.csv("Chapter/Subgroup Table/CAD_Xpert_plot_WalkIn.csv")
CAD_Xpert_plot_Referral <- read.csv("Chapter/Subgroup Table/CAD_Xpert_plot_Referral.csv")
CAD_Xpert_plot_New <- read.csv("Chapter/Subgroup Table/CAD_Xpert_plot_New.csv")
CAD_Xpert_plot_Old <- read.csv("Chapter/Subgroup Table/CAD_Xpert_plot_Old.csv")


SubgroupTable <- rbind(CAD_Xpert_plot_New, CAD_Xpert_plot_Old, CAD_Xpert_plot_Young, CAD_Xpert_plot_Middle, CAD_Xpert_plot_Senior, CAD_Xpert_plot_Referral, CAD_Xpert_plot_DOTS, CAD_Xpert_plot_WalkIn)
# write.csv(SubgroupTable, "Chapter/Subgroup Table/SubgroupTable.csv", row.names = F)
# rm(list=(ls()))
```

```{r AUC}
## All

library(precrec)
library(ggplot2)

ROCPRC <- function(dataset, dataset_long){
  attr <- attributes(evalmod(scores = dataset$CAD4TB6, labels = dataset$Xpert2Outcome_num))
  aucT1 <- c("CAD4TB ", round(attr$auc[4],3))
  
  attr <- attributes(evalmod(scores = dataset$qXRv2, labels = dataset$Xpert2Outcome_num))
  aucT2 <- c("qXR ", round(attr$auc[4],3))
  
  attr <- attributes(evalmod(scores = dataset$LunitScore, labels = dataset$Xpert2Outcome_num))
  aucT3 <- c("Lunit INSIGHT CXR  ", round(attr$auc[4],3))
  
  attr <- attributes(evalmod(scores = dataset$JF1, labels = dataset$Xpert2Outcome_num))
  aucT4 <- c("JF CXR-1 ", round(attr$auc[4],3))
  
  attr <- attributes(evalmod(scores = dataset$IF2, labels = dataset$Xpert2Outcome_num))
  aucT5 <- c("InferReadDR ", round(attr$auc[4],3))
  
  # return(mmcurves)
  # return(autoplot(mmcurves))
  aucT <- c(aucT1, aucT2, aucT3, aucT4, aucT5)
  return(aucT)
}

l <- ROCPRC(MDF, MDF_long)
all <- data.frame(matrix(unlist(l), nrow=5, byrow=T))
all$subgroup <- "all"


## New only
l <- ROCPRC(New, New_long)
New <- data.frame(matrix(unlist(l), nrow=5, byrow=T))
New$subgroup <- "New cases"

## Old only
l <- ROCPRC(Old, Old_long)
Old <- data.frame(matrix(unlist(l), nrow=5, byrow=T))
Old$subgroup <- "Previously treated cases"

## Young
l <- ROCPRC(Young, Young_long)
Young <- data.frame(matrix(unlist(l), nrow=5, byrow=T))
Young$subgroup <- "Young age"

## Middle
l <- ROCPRC(Middle, Middle_long)
Middle <- data.frame(matrix(unlist(l), nrow=5, byrow=T))
Middle$subgroup <- "Middle age"

## Senior
l <- ROCPRC(Senior, Senior_long)
Senior <- data.frame(matrix(unlist(l), nrow=5, byrow=T))
Senior$subgroup <- "Old age"

## Referral only
l <- ROCPRC(Referral, Referral_long)
Referral <- data.frame(matrix(unlist(l), nrow=5, byrow=T))
Referral$subgroup <- "Referred"

## DOTS only
l <- ROCPRC(DOTS, DOTS_long)
DOTS <- data.frame(matrix(unlist(l), nrow=5, byrow=T))
DOTS$subgroup <- "DOTS retested"

## Walk-in only
l <- ROCPRC(WalkIn, WalkIn_long)
WalkIn <- data.frame(matrix(unlist(l), nrow=5, byrow=T))
WalkIn$subgroup <- "WalkIn"

# ## Missing 
# l <- ROCPRC(Missing, Missing_long)
# Missing <- data.frame(matrix(unlist(l), nrow=5, byrow=T))
# Missing$subgroup <- "Missing"

aucTable <- rbind(all, New, Old, Young, Middle, Senior, Referral, DOTS, WalkIn)
colnames(aucTable) <- c("DL System", "AUC", "PCAUC", "Subgroup")
write.csv(aucTable, "Results/aucTable.csv")
# rm(list=(ls()))

```


## Subgroup Curves
```{r subgroup curves, eval=F}
# subgroup 4 curves

SubgroupPlot <- read.csv("Chapter/Subgroup Table/SubgroupTable.csv")
SubgroupPlot <- SubgroupPlot[, -1]
SubgroupPlot$Score[SubgroupPlot$DeepLearningSystem %in% "CAD4TB"] <- SubgroupPlot$Score[SubgroupPlot$DeepLearningSystem %in% "CAD4TB"]/100
SubgroupPlot$subgroup <- as.character(SubgroupPlot$subgroup)
SubgroupPlot$subgroup[SubgroupPlot$subgroup %in% "New"] <- "1.New Case"
SubgroupPlot$subgroup[SubgroupPlot$subgroup %in% "Old"] <- "2.Previously Treated Case"
SubgroupPlot$subgroup[SubgroupPlot$subgroup %in% "Young"] <- "3.Young age [15,25)"
SubgroupPlot$subgroup[SubgroupPlot$subgroup %in% "Middle"] <- "4.Middle age [25,60)"
SubgroupPlot$subgroup[SubgroupPlot$subgroup %in% "Senior"] <- "5.Old age [60,108]"
SubgroupPlot$subgroup[SubgroupPlot$subgroup %in% "DOTS"] <- "7.Public DOTS Retesting"
SubgroupPlot$subgroup[SubgroupPlot$subgroup %in% "Referral"] <-"6.Private Public Referral"
SubgroupPlot$subgroup[SubgroupPlot$subgroup %in% "WalkIn"] <-"8.Walk In"
SubgroupPlot$subgroup <- as.factor(SubgroupPlot$subgroup)

SubgroupPlotOrigin <- SubgroupPlot
# SubgroupPlot <- SubgroupPlotOrigin
# Choose the DL System
# SubgroupPlot <- SubgroupPlotOrigin[SubgroupPlotOrigin$DeepLearningSystem %in% "CAD4TB", ]
# SubgroupPlot <- SubgroupPlotOrigin[SubgroupPlotOrigin$DeepLearningSystem %in% "IF2", ]
# SubgroupPlot <- SubgroupPlotOrigin[SubgroupPlotOrigin$DeepLearningSystem %in% "JF1", ]
# SubgroupPlot <- SubgroupPlotOrigin[SubgroupPlotOrigin$DeepLearningSystem %in% "Lunit", ]
SubgroupPlot <- SubgroupPlotOrigin[SubgroupPlotOrigin$DeepLearningSystem %in% "qXR", ]

### GO TO AND RUN source("Chapter/Subgroup Table/SubGroupPlot.R")

```

```{r Bar chart}
aucTable <- read.csv("Results/aucTable.csv")
aucTable <- aucTable[, -1]

### AUC
age<-ggplot(aucTable[aucTable$Subgroup %in% c("Young age", "Middle age", "Old age"), ], aes(x=DL.System, y=AUC, fill=Subgroup)) +  geom_bar(stat="identity", width=0.6, position=position_dodge())+theme_minimal()+ theme(legend.position = "top")+  ylim(0, 0.95) + theme(panel.grid.minor = element_line(size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.95, 0.05), breaks = seq(0.65, 0.95, 0.05)) 

referral<-ggplot(aucTable[aucTable$Subgroup %in% c("Referred", "DOTS retested", "WalkIn"), ], aes(x=DL.System, y=AUC, fill=Subgroup)) + geom_bar(stat="identity", width=0.7, position=position_dodge())+theme_minimal()+ theme(legend.position = "top")+  ylim(0, 0.95) + theme(panel.grid.minor = element_line(size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.95, 0.05), breaks = seq(0.65, 0.95, 0.05)) 

history<-ggplot(aucTable[aucTable$Subgroup %in% c("New cases", "Previously treated cases"), ], aes(x=DL.System, y=AUC, fill=Subgroup)) + geom_bar(stat="identity", width=0.5, position=position_dodge())+theme_minimal() + theme(legend.position = "top") +  ylim(0, 0.95) + theme(panel.grid.minor = element_line(size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.95, 0.05), breaks = seq(0.65, 0.95, 0.05)) 

### PRC
agePC<-ggplot(aucTable[aucTable$Subgroup %in% c("Young age", "Middle age", "Old age"), ], aes(x=DL.System, y=PCAUC, fill=Subgroup)) +  geom_bar(stat="identity", width=0.6, position=position_dodge())+theme_minimal()+ theme(legend.position = "top")+  ylim(0.3, 0.8) + theme(panel.grid.minor = element_line(size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.8, 0.05), breaks = seq(0.3, 0.8, 0.05)) 

referralPC<-ggplot(aucTable[aucTable$Subgroup %in% c("Referred", "DOTS retested", "WalkIn"), ], aes(x=DL.System, y=PCAUC, fill=Subgroup)) + geom_bar(stat="identity", width=0.7, position=position_dodge())+theme_minimal()+ theme(legend.position = "top")+  ylim(0.3, 0.8) + theme(panel.grid.minor = element_line(size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.8, 0.05), breaks = seq(0.3, 0.8, 0.05)) 

historyPC<-ggplot(aucTable[aucTable$Subgroup %in% c("New cases", "Previously treated cases"), ], aes(x=DL.System, y=PCAUC, fill=Subgroup)) + geom_bar(stat="identity", width=0.5, position=position_dodge())+theme_minimal() + theme(legend.position = "top") +  ylim(0.3, 0.8) + theme(panel.grid.minor = element_line(size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.8, 0.05), breaks = seq(0.3, 0.8, 0.05)) 


tiff("Results/AUC plot.tif", width = 18, height = 8, units = "in", res = 100)
require(gridExtra)
grid.arrange(age, referral, history, agePC, referralPC, historyPC, ncol=3)

dev.off()
rm(age, referral, history, agePC, referralPC, historyPC)
```



