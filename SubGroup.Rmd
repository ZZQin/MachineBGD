```{r Global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=15, fig.height=12, echo=FALSE, warning=FALSE, message=FALSE)
```


```{r eval=F}
source("DataWrangling/GlobalOption.R")
source("radiologist.R")
Radiologist <- Radiologist[Radiologist$Referral %in% "MDF", ]

New <- MDF[MDF$TB.Medication.History %in% "No",]
Old <- MDF[MDF$TB.Medication.History %in% "Yes",]

Female <- MDF[MDF$Gender %in% "F", ]
Male <- MDF[MDF$Gender %in% "M", ]

Young <- MDF[MDF$AgeGroup %in% "[15,25)",]
Middle <- MDF[MDF$AgeGroup %in% "[25,60)",]
Senior <- MDF[MDF$AgeGroup %in% "[60,108]",]

Referral <- subset(MDF, MDF$UseCase %in% "PrivatePublicReferral")
DOTS <- subset(MDF, MDF$UseCase %in% "PublicDOTSRetesting")
WalkIn <- subset(MDF, MDF$UseCase %in% "WalkIn")
# Missing <- subset(MDF, is.na(MDF$UseCase)==T)

New_long <- MDF_long[MDF_long$TB.Medication.History %in% "No",]
Old_long <- MDF_long[MDF_long$TB.Medication.History %in% "Yes",]
Young_long <- MDF_long[MDF_long$AgeGroup %in% "[15,25)",]
Middle_long <- MDF_long[MDF_long$AgeGroup %in% "[25,60)",]
Senior_long <- MDF_long[MDF_long$AgeGroup %in% "[60,108]",]

Referral_long  <- subset(MDF_long, MDF_long$UseCase %in% "PrivatePublicReferral")
DOTS_long  <- subset(MDF_long, MDF_long$UseCase %in% "PublicDOTSRetesting")
WalkIn_long  <- subset(MDF_long, MDF_long$UseCase %in% "WalkIn")

```

```{r 2 AUC}
## All

library(precrec)
library(ggplot2)

ROCPRC <- function(dataset){
  attr <- attributes(evalmod(scores = dataset$CAD4TB6, labels = dataset$Xpert2Outcome_num))
  aucT1 <- c("CAD4TB ", round(attr$auc[4],3))
  
  attr <- attributes(evalmod(scores = dataset$qXRv3, labels = dataset$Xpert2Outcome_num))
  aucT2 <- c("qXR ", round(attr$auc[4],3))
  
  attr <- attributes(evalmod(scores = dataset$LunitScore, labels = dataset$Xpert2Outcome_num))
  aucT3 <- c("Lunit INSIGHT CXR", round(attr$auc[4],3))
  
  attr <- attributes(evalmod(scores = dataset$JF1, labels = dataset$Xpert2Outcome_num))
  aucT4 <- c("JF CXR-1", round(attr$auc[4],3))
  
  attr <- attributes(evalmod(scores = dataset$IF2, labels = dataset$Xpert2Outcome_num))
  aucT5 <- c("InferReadDR ", round(attr$auc[4],3))
  
  # return(mmcurves)
  # return(autoplot(mmcurves))
  aucT <- c(aucT1, aucT2, aucT3, aucT4, aucT5)
  return(aucT)
}

l <- ROCPRC(MDF)
all <- data.frame(matrix(unlist(l), nrow=5, byrow=T))
all$subgroup <- "all"


## New only
l <- ROCPRC(New)
New <- data.frame(matrix(unlist(l), nrow=5, byrow=T))
New$subgroup <- "New cases"

## Old only
l <- ROCPRC(Old)
Old <- data.frame(matrix(unlist(l), nrow=5, byrow=T))
Old$subgroup <- "Previously treated cases"

## Young
l <- ROCPRC(Young)
Young <- data.frame(matrix(unlist(l), nrow=5, byrow=T))
Young$subgroup <- "Young age"

## Middle
l <- ROCPRC(Middle)
Middle <- data.frame(matrix(unlist(l), nrow=5, byrow=T))
Middle$subgroup <- "Middle age"

## Senior
l <- ROCPRC(Senior)
Senior <- data.frame(matrix(unlist(l), nrow=5, byrow=T))
Senior$subgroup <- "Old age"

## Referral only
l <- ROCPRC(Referral)
Referral <- data.frame(matrix(unlist(l), nrow=5, byrow=T))
Referral$subgroup <- "Referred"

## DOTS only
l <- ROCPRC(DOTS)
DOTS <- data.frame(matrix(unlist(l), nrow=5, byrow=T))
DOTS$subgroup <- "DOTS retested"

## Walk-in only
l <- ROCPRC(WalkIn)
WalkIn <- data.frame(matrix(unlist(l), nrow=5, byrow=T))
WalkIn$subgroup <- "WalkIn"

## Female
l <- ROCPRC(Female)
Female <- data.frame(matrix(unlist(l), nrow=5, byrow=T))
Female$subgroup <- "Female"

## Male
l <- ROCPRC(Male)
Male <- data.frame(matrix(unlist(l), nrow=5, byrow=T))
Male$subgroup <- "Male"
#### stratification by age AND prior TB history


aucTable <- rbind(all, New, Old, Young, Middle, Senior, Referral, DOTS, WalkIn, Female, Male)
colnames(aucTable) <- c("AI.Algorithm", "AUC", "PCAUC", "Subgroup")
write.csv(aucTable, "Results/aucTable.csv")
rm(list=(ls()))
```


```{r PRAUC CI}
data(P10N10)

s1 <- c(1, 2, 3, 4)
s2 <- c(5, 6, 7, 8)
s3 <- matrix(1:8, 4, 2)

# Join two score vectors
scores1 <- join_scores(s1, s2)

# Join two vectors and a matrix
scores2 <- join_scores(s1, s2, s3)

l1 <- c(1, 0, 1, 1)
l2 <- c(1, 0, 1, 1)
l3 <- c(1, 0, 1, 0)

# Join two label vectors
labels1 <- join_labels(l1, l2)
labels2 <- join_labels(l1, l3)

# A dataset with 20 samples for the good early retrieval performance level
samps3 <- create_sim_samples(20, 10, 10, "good_er")

# Calculate ROC and Precision-Recall curves
sscurves <- evalmod(scores = P10N10$scores, labels = P10N10$labels)

# Specify test dataset IDs names
smmdat1 <- mmdata(scores1, labels2, dsids = c(1,2))

# Use a sample dataset created by the create_sim_samples function
smmdat2 <- mmdata(samps3[["scores"]], samps3[["labels"]], dsids = samps3[["dsids"]])

# Calculate curves for multiple test datasets and keep all the curves
smcurves <- evalmod(smmdat2, raw_curves = TRUE)

autoplot(smcurves, "PRC", show_cb = TRUE)
```


```{r ROC AUC with CI}

library(pROC)
ROC <- function(dataset){
  roc_CAD6 <- ci.auc(Xpert2Outcome_num ~ CAD4TB6, dataset)
  roc_qure <- ci.auc(Xpert2Outcome_num ~ qXRv3_100, dataset)
  roc_Lunit <- ci.auc(Xpert2Outcome_num ~ LunitScore_100, dataset)
  roc_JF1 <- ci.auc(Xpert2Outcome_num ~ JF1_100, dataset)
  roc_IF2 <- ci.auc(Xpert2Outcome_num ~ IF2_100, dataset)

  aucT <- as.data.frame(matrix(c(roc_CAD6[2], roc_CAD6[1], roc_CAD6[3], roc_qure[2], roc_qure[1], roc_qure[3], roc_Lunit[2], roc_Lunit[1], roc_Lunit[3], roc_JF1[2], roc_JF1[1], roc_JF1[3], roc_IF2[2], roc_IF2[1], roc_IF2[3]),  byrow=TRUE, ncol =  3))
  names(aucT) <- c("AUC", "AUCL", "AUCH")
  aucT$AI.Algorithm <- c("CAD4TB", "qXR", "Lunit INSIGHT CXR", "JF CXR-1", "InferReadDR")
  
  
  return(aucT)
}


## New only
New <- ROC(New)
New$subgroup <- "New cases"

## Old only
Old <- ROC(Old)
Old$subgroup <- "Previously treated cases"

## Young
Young <- ROC(Young)
Young$subgroup <- "Young age"

## Middle
Middle <- ROC(Middle)
Middle$subgroup <- "Middle age"

## Senior
Senior <- ROC(Senior)
Senior$subgroup <- "Old age"

## Referral only
Referral <- ROC(Referral)
Referral$subgroup <- "Referred"

## DOTS only
DOTS <- ROC(DOTS)
DOTS$subgroup <- "DOTS retested"

## Walk-in only
WalkIn <- ROC(WalkIn)
WalkIn$subgroup <- "WalkIn"

ROCaucTable <- rbind(New, Old, Young, Middle, Senior, Referral, DOTS, WalkIn)
View(ROCaucTable)
write.csv(ROCaucTable, "Results/ROCaucTable.csv", row.names = F)


```


## Subgroup Curves
```{r subgroup curves, eval=F}
# subgroup 4 curves

SubgroupPlot <- read.csv("Chapter/Subgroup Table/SubgroupTable.csv")
SubgroupPlot <- SubgroupPlot[, -1]
SubgroupPlot$Score[SubgroupPlot$DeepLearningSystem %in% "CAD4TB"] <- SubgroupPlot$Score[SubgroupPlot$DeepLearningSystem %in% "CAD4TB"]/100
SubgroupPlot$subgroup <- as.character(SubgroupPlot$subgroup)
SubgroupPlot$subgroup[SubgroupPlot$subgroup %in% "New"] <- "1.New Case"
SubgroupPlot$subgroup[SubgroupPlot$subgroup %in% "Old"] <- "2.Previously Treated Case"
SubgroupPlot$subgroup[SubgroupPlot$subgroup %in% "Young"] <- "3.Young age [15,25)"
SubgroupPlot$subgroup[SubgroupPlot$subgroup %in% "Middle"] <- "4.Middle age [25,60)"
SubgroupPlot$subgroup[SubgroupPlot$subgroup %in% "Senior"] <- "5.Old age [60,108]"
SubgroupPlot$subgroup[SubgroupPlot$subgroup %in% "DOTS"] <- "7.Public DOTS Retesting"
SubgroupPlot$subgroup[SubgroupPlot$subgroup %in% "Referral"] <-"6.Private Public Referral"
SubgroupPlot$subgroup[SubgroupPlot$subgroup %in% "WalkIn"] <-"8.Walk In"
SubgroupPlot$subgroup <- as.factor(SubgroupPlot$subgroup)

SubgroupPlotOrigin <- SubgroupPlot
# SubgroupPlot <- SubgroupPlotOrigin
# Choose the DL System
# SubgroupPlot <- SubgroupPlotOrigin[SubgroupPlotOrigin$DeepLearningSystem %in% "CAD4TB", ]
# SubgroupPlot <- SubgroupPlotOrigin[SubgroupPlotOrigin$DeepLearningSystem %in% "IF2", ]
# SubgroupPlot <- SubgroupPlotOrigin[SubgroupPlotOrigin$DeepLearningSystem %in% "JF1", ]
# SubgroupPlot <- SubgroupPlotOrigin[SubgroupPlotOrigin$DeepLearningSystem %in% "Lunit", ]
SubgroupPlot <- SubgroupPlotOrigin[SubgroupPlotOrigin$DeepLearningSystem %in% "qXR", ]

### GO TO AND RUN source("Chapter/Subgroup Table/SubGroupPlot.R")

```

```{r Bar chart}
aucTable <- read.csv("Results/aucTable.csv")
aucTable <- aucTable[, -1]

aucTable$Subgroup <- factor(aucTable$Subgroup, levels = c("Young age", "Middle age", "Old age", "Referred", "DOTS retested", "WalkIn", "New cases", "Previously treated cases", "Female", "Male"))
### AUC
age<-ggplot(aucTable[aucTable$Subgroup %in% c("Young age", "Middle age", "Old age"), ], aes(x=AI.Algorithm, y=AUC, fill=Subgroup)) +  geom_bar(stat="identity", width=0.6, position=position_dodge())+theme_minimal()+ theme(legend.position = "top")+  ylim(0, 0.95) + theme(panel.grid.minor = element_line(size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.95, 0.05), breaks = seq(0.65, 0.95, 0.05)) 

referral<-ggplot(aucTable[aucTable$Subgroup %in% c("Referred", "DOTS retested", "WalkIn"), ], aes(x=AI.Algorithm, y=AUC, fill=Subgroup)) + geom_bar(stat="identity", width=0.7, position=position_dodge())+theme_minimal()+ theme(legend.position = "top")+  ylim(0, 0.95) + theme(panel.grid.minor = element_line(size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.95, 0.05), breaks = seq(0.65, 0.95, 0.05)) 

history<-ggplot(aucTable[aucTable$Subgroup %in% c("New cases", "Previously treated cases"), ], aes(x=AI.Algorithm, y=AUC, fill=Subgroup)) + geom_bar(stat="identity", width=0.5, position=position_dodge())+theme_minimal() + theme(legend.position = "top") +  ylim(0, 0.95) + theme(panel.grid.minor = element_line(size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.95, 0.05), breaks = seq(0.65, 0.95, 0.05)) 

gender <- ggplot(aucTable[aucTable$Subgroup %in% c("Female", "Male"), ], aes(x=AI.Algorithm, y=AUC, fill=Subgroup)) + geom_bar(stat="identity", width=0.5, position=position_dodge())+theme_minimal() + theme(legend.position = "top") +  ylim(0, 0.95) + theme(panel.grid.minor = element_line(size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.95, 0.05), breaks = seq(0.65, 0.95, 0.05)) 

### PRC
agePC<-ggplot(aucTable[aucTable$Subgroup %in% c("Young age", "Middle age", "Old age"), ], aes(x=AI.Algorithm, y=PCAUC, fill=Subgroup)) +  geom_bar(stat="identity", width=0.6, position=position_dodge())+theme_minimal()+ theme(legend.position = "top")+  ylim(0.3, 0.8) + theme(panel.grid.minor = element_line(size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.8, 0.05), breaks = seq(0.3, 0.8, 0.05)) 

referralPC<-ggplot(aucTable[aucTable$Subgroup %in% c("Referred", "DOTS retested", "WalkIn"), ], aes(x=AI.Algorithm, y=PCAUC, fill=Subgroup)) + geom_bar(stat="identity", width=0.7, position=position_dodge())+theme_minimal()+ theme(legend.position = "top")+  ylim(0.3, 0.8) + theme(panel.grid.minor = element_line(size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.8, 0.05), breaks = seq(0.3, 0.8, 0.05)) 

historyPC<-ggplot(aucTable[aucTable$Subgroup %in% c("New cases", "Previously treated cases"), ], aes(x=AI.Algorithm, y=PCAUC, fill=Subgroup)) + geom_bar(stat="identity", width=0.5, position=position_dodge())+theme_minimal() + theme(legend.position = "top") +  ylim(0.3, 0.8) + theme(panel.grid.minor = element_line(size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.8, 0.05), breaks = seq(0.3, 0.8, 0.05)) 

genderPC <- ggplot(aucTable[aucTable$Subgroup %in% c("Female", "Male"), ], aes(x=AI.Algorithm, y=PCAUC, fill=Subgroup)) + geom_bar(stat="identity", width=0.5, position=position_dodge())+theme_minimal() + theme(legend.position = "top") +  ylim(0, 0.95) + theme(panel.grid.minor = element_line(size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.95, 0.05), breaks = seq(0.65, 0.95, 0.05)) 


tiff("Results/PRC ROC AUC plot.tif", width = 18, height = 8, units = "in", res = 100)
require(gridExtra)

grid.arrange(age, referral, history, gender, agePC, referralPC, historyPC, genderPC, ncol=4)
# grid.arrange(age, referral, history, ncol=3)

dev.off()
# rm(age, referral, history, agePC, referralPC, historyPC, gender, genderPC)

tiff("Results/PRC AUC plot.tif", width = 9, height = 8, units = "in", res = 100)
grid.arrange(agePC, referralPC, historyPC, genderPC, ncol=2)
dev.off()
```

```{r}
ROCaucTable <- read.csv("Results/ROCaucTable.csv")
ROCaucTable$subgroup <- factor(ROCaucTable$subgroup, levels = c("Young age", "Middle age", "Old age", "Referred", "DOTS retested", "WalkIn", "New cases", "Previously treated cases"))
### AUC
age <-ggplot(ROCaucTable[ROCaucTable$subgroup %in% c("Young age", "Middle age", "Old age"), ], aes(x=AI.Algorithm, y=AUC, fill=subgroup)) +  geom_bar(stat="identity", width=0.6, position=position_dodge()) + geom_errorbar(aes(ymin=AUCL, ymax=AUCH), width=.2, position=position_dodge(0.7)) + theme_minimal()+ theme(legend.position = "top")+  ylim(0, 0.95) + theme(panel.grid.minor = element_line(size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.95, 0.05), breaks = seq(0.65, 0.95, 0.05)) 
age

referral<-ggplot(ROCaucTable[ROCaucTable$subgroup %in% c("Referred", "DOTS retested", "WalkIn"), ], aes(x=AI.Algorithm, y=AUC, fill=subgroup)) + geom_bar(stat="identity", width=0.7, position=position_dodge())+theme_minimal()+ theme(legend.position = "top")+  ylim(0, 0.95) + theme(panel.grid.minor = element_line(size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.95, 0.05), breaks = seq(0.65, 0.95, 0.05)) + geom_errorbar(aes(ymin=AUCL, ymax=AUCH), width=.2, position=position_dodge(0.6)) 
referral

history<-ggplot(ROCaucTable[ROCaucTable$subgroup %in% c("New cases", "Previously treated cases"), ], aes(x=AI.Algorithm, y=AUC, fill=subgroup)) + geom_bar(stat="identity", width=0.5, position=position_dodge())+theme_minimal() + theme(legend.position = "top") +  ylim(0, 0.95) + theme(panel.grid.minor = element_line(size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.95, 0.05), breaks = seq(0.65, 0.95, 0.05)) + geom_errorbar(aes(ymin=AUCL, ymax=AUCH), width=.2, position=position_dodge(0.6))

tiff("Results/ROC_AUC plot.tif", width = 13, height = 3, units = "in", res = 100)
require(gridExtra)

grid.arrange(age, referral, history, ncol=3)

dev.off()
rm(age, referral, history)
```



