```{r Global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=15, fig.height=12, echo=FALSE, warning=FALSE, message=FALSE)
```


```{r eval=F}
source("DataWrangling/GlobalOption.R")
source("radiologist.R")
Radiologist <- Radiologist[Radiologist$Referral %in% "MDF", ]

New <- MDF[MDF$TB.Medication.History %in% "No",]
Old <- MDF[MDF$TB.Medication.History %in% "Yes",]

Young <- MDF[MDF$AgeGroup %in% "[15,25)",]
Middle <- MDF[MDF$AgeGroup %in% "[25,60)",]
Senior <- MDF[MDF$AgeGroup %in% "[60,108]",]

Private <- subset(MDF, MDF$Referral %in% "Private Provider")
Public <- subset(MDF, MDF$Referral %in% "Public DOTS Facilities")
WalkIn <- subset(MDF, MDF$Referral %in% "Walk-in")
Missing <- subset(MDF, is.na(MDF$Referral)==T)

New_long <- MDF_long[MDF_long$TB.Medication.History %in% "No",]
Old_long <- MDF_long[MDF_long$TB.Medication.History %in% "Yes",]
Young_long <- MDF_long[MDF_long$AgeGroup %in% "[15,25)",]
Middle_long <- MDF_long[MDF_long$AgeGroup %in% "[25,60)",]
Senior_long <- MDF_long[MDF_long$AgeGroup %in% "[60,108]",]
Private_long <- subset(MDF_long, MDF_long$Referral %in% "Private Provider")
Public_long <- subset(MDF_long, MDF_long$Referral %in% "Public DOTS Facilities")
WalkIn_long <- subset(MDF_long, MDF_long$Referral %in% "Walk-in")
Missing_long <- subset(MDF_long, is.na(MDF_long$Referral)==T)

# source("Chapter/Subgroup Table/Young.R")
# source("Chapter/Subgroup Table/Middle.R")
# source("Chapter/Subgroup Table/Senior.R")
# source("Chapter/Subgroup Table/Private.R")
# source("Chapter/Subgroup Table/Public.R")
# # write.csv(CAD_Xpert_plot_Middle, "Chapter/Subgroup Table/CAD_Xpert_plot_Middle.csv")
# # write.csv(CAD_Xpert_plot_Young, "Chapter/Subgroup Table/CAD_Xpert_plot_Young.csv")
# # write.csv(CAD_Xpert_plot_Senior, "Chapter/Subgroup Table/CAD_Xpert_plot_Senior.csv")
# # write.csv(CAD_Xpert_plot_Private, "Chapter/Subgroup Table/CAD_Xpert_plot_Private.csv")
# # write.csv(CAD_Xpert_plot_Public, "Chapter/Subgroup Table/CAD_Xpert_plot_Public.csv")
# 
# source("Chapter/Subgroup Table/WalkIn.R")
# source("Chapter/Subgroup Table/Missing.R")
# source("Chapter/Subgroup Table/New.R")
# source("Chapter/Subgroup Table/Old.R")
# 
# 
# # save(CAD_Xpert_plot_Young, "Young.rdata")
# SubgroupTable <- rbind(CAD_Xpert_plot_New, CAD_Xpert_plot_Old, CAD_Xpert_plot_Young, CAD_Xpert_plot_Middle, CAD_Xpert_plot_Senior, CAD_Xpert_plot_Private, CAD_Xpert_plot_Public, CAD_Xpert_plot_WalkIn, CAD_Xpert_plot_Missing)
# write.csv(SubgroupTable, "Chapter/Subgroup Table/SubgroupTable.csv")
```

## Subgroup Curves
```{r subgroup curves, eval=F}
# subgroup 4 curves
SubgroupPlot <- read.csv("Chapter/Subgroup Table/SubgroupTable.csv")
SubgroupPlot <- SubgroupPlot[, -1]
SubgroupPlot$Score[SubgroupPlot$DeepLearningSystem %in% "CAD4TB"] <- SubgroupPlot$Score[SubgroupPlot$DeepLearningSystem %in% "CAD4TB"]/100
SubgroupPlotOrigin <- SubgroupPlot

# Choose the DL System
# SubgroupPlot <- SubgroupPlotOrigin[SubgroupPlotOrigin$DeepLearningSystem %in% "CAD4TB", ]
# SubgroupPlot <- SubgroupPlotOrigin[SubgroupPlotOrigin$DeepLearningSystem %in% "IF2", ]
# SubgroupPlot <- SubgroupPlotOrigin[SubgroupPlotOrigin$DeepLearningSystem %in% "JF1", ]
# SubgroupPlot <- SubgroupPlotOrigin[SubgroupPlotOrigin$DeepLearningSystem %in% "Lunit", ]
SubgroupPlot <- SubgroupPlotOrigin[SubgroupPlotOrigin$DeepLearningSystem %in% "qXR", ]

### GO TO AND RUN source("Chapter/Subgroup Table/SubGroupPlot.R")

```

```{r Bar chart}
aucTable <- read.csv("Results/aucTable.csv")
aucTable <- aucTable[, -1]

### AUC
age<-ggplot(aucTable[aucTable$Subgroup %in% c("Young", "Middle", "Senior"), ], aes(x=DL.System, y=AUC, fill=Subgroup)) +  geom_bar(stat="identity", width=0.6, position=position_dodge())+theme_minimal()+ theme(legend.position = "top")+  ylim(0, 0.95) + theme(panel.grid.minor = element_line(colour="grey", size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.95, 0.05), breaks = seq(0.65, 0.95, 0.05)) 

referral<-ggplot(aucTable[aucTable$Subgroup %in% c("Private", "Public", "WalkIn", "Missing"), ], aes(x=DL.System, y=AUC, fill=Subgroup)) + geom_bar(stat="identity", width=0.7, position=position_dodge())+theme_minimal()+ theme(legend.position = "top")+  ylim(0, 0.95) + theme(panel.grid.minor = element_line(colour="grey", size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.95, 0.05), breaks = seq(0.65, 0.95, 0.05)) 

history<-ggplot(aucTable[aucTable$Subgroup %in% c("New", "Old"), ], aes(x=DL.System, y=AUC, fill=Subgroup)) + geom_bar(stat="identity", width=0.5, position=position_dodge())+theme_minimal() + theme(legend.position = "top") +  ylim(0, 0.95) + theme(panel.grid.minor = element_line(colour="grey", size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.95, 0.05), breaks = seq(0.65, 0.95, 0.05)) 

### PRC
agePC<-ggplot(aucTable[aucTable$Subgroup %in% c("Young", "Middle", "Senior"), ], aes(x=DL.System, y=PCAUC, fill=Subgroup)) +  geom_bar(stat="identity", width=0.6, position=position_dodge())+theme_minimal()+ theme(legend.position = "top")+  ylim(0.3, 0.8) + theme(panel.grid.minor = element_line(colour="grey", size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.8, 0.05), breaks = seq(0.3, 0.8, 0.05)) 

referralPC<-ggplot(aucTable[aucTable$Subgroup %in% c("Private", "Public", "WalkIn", "Missing"), ], aes(x=DL.System, y=PCAUC, fill=Subgroup)) + geom_bar(stat="identity", width=0.7, position=position_dodge())+theme_minimal()+ theme(legend.position = "top")+  ylim(0.3, 0.8) + theme(panel.grid.minor = element_line(colour="grey", size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.8, 0.05), breaks = seq(0.3, 0.8, 0.05)) 

historyPC<-ggplot(aucTable[aucTable$Subgroup %in% c("New", "Old"), ], aes(x=DL.System, y=PCAUC, fill=Subgroup)) + geom_bar(stat="identity", width=0.5, position=position_dodge())+theme_minimal() + theme(legend.position = "top") +  ylim(0.3, 0.8) + theme(panel.grid.minor = element_line(colour="grey", size=0.5)) + scale_y_continuous(minor_breaks = seq(0 , 0.8, 0.05), breaks = seq(0.3, 0.8, 0.05)) 


tiff("Results/AUC plot.tif", width = 18, height = 8, units = "in", res = 100)
require(gridExtra)
grid.arrange(age, referral, history, agePC, referralPC, historyPC, ncol=3)

dev.off()
```



